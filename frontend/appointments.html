<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Book Appointment</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <h1>üîç Search Providers</h1>
  <input type="text" id="searchInput" placeholder="Search by name, email, or specialization"/>
  <button onclick="searchProviders()">Search</button>
  <ul id="providerResults"></ul>

  <h2>üìÖ Provider Calendar</h2>
  <div id="calendar"></div>

  <!-- üì§ Confirm Booking Dialog -->
  <dialog id="bookingDialog">
    <p id="bookingText"></p>
    <button id="confirmBookingBtn">Send Request</button>
    <button onclick="document.getElementById('bookingDialog').close()">Cancel</button>
  </dialog>

  <!-- ‚úÖ Confirmation Dialog -->
  <dialog id="confirmationDialog">
    <p>‚úÖ Appointment request sent successfully!</p>
    <button onclick="document.getElementById('confirmationDialog').close()">Close</button>
  </dialog>

  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script>
    let selectedProviderId = null;
    let selectedSlot = null;

    async function searchProviders() {
      const query = document.getElementById('searchInput').value.trim();
      const res = await fetch(`/api/providers/search?query=${query}`);
      const providers = await res.json();

      const list = document.getElementById('providerResults');
      list.innerHTML = '';
      providers.forEach(p => {
        const li = document.createElement('li');
        li.textContent = `${p.name} (${p.specialization || 'N/A'})`;
        li.onclick = () => loadCalendar(p.user_id);
        list.appendChild(li);
      });
    }

    async function loadCalendar(providerId) {
      selectedProviderId = providerId;
      const res = await fetch(`/api/providers/${providerId}/availability`);
      const availability = await res.json();

      const events = availability.map(slot => ({
        title: 'Available',
        start: `${slot.day_of_week}T${slot.start_time}`,
        allDay: false
      }));

      const calendarEl = document.getElementById('calendar');
      calendarEl.innerHTML = ''; // Clear previous calendar

      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',
        timeZone: 'local',
        events,
        dateClick: function(info) {
          selectedSlot = info.dateStr;

          const date = selectedSlot.split('T')[0];
          const time = selectedSlot.split('T')[1].slice(0, 5);
          document.getElementById('bookingText').textContent =
            `Do you want to send a request for ${date} at ${time}?`;

          document.getElementById('bookingDialog').showModal();
        }
      });

      calendar.render();
    }

    // Handle confirm booking
    document.getElementById('confirmBookingBtn').onclick = async () => {
      const userId = localStorage.getItem('userId');
      if (!userId || !selectedProviderId || !selectedSlot) return;

      const date = selectedSlot.split('T')[0];
      const time = selectedSlot.split('T')[1].slice(0, 5);

      try {
        const res = await fetch('/api/appointment-requests', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            client_id: userId,
            provider_id: selectedProviderId,
            requested_date: date,
            requested_time: time
          })
        });

        const data = await res.json();
        document.getElementById('bookingDialog').close();

        if (res.ok) {
          document.getElementById('confirmationDialog').showModal();
        } else {
          alert(data.message || 'Failed to send request');
        }
      } catch (err) {
        console.error(err);
        alert('Server error');
      }
    };
  </script>
</body>
</html>
